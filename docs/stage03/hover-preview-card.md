# Stage03 — 左侧 Hover 信息卡片（Preview Card）设计

范围：Topic 页面左侧可视化区域（`SunburstView / FocusView / GodView`）在**鼠标滑过节点**时展示的信息卡片。本文只解决 hover 卡片的**信息量与阅读体感**，不涉及“引用/编辑器内引用”等需求。

约束（来自需求）：

- Hover 卡片显示作者**昵称**（`authorDisplayName` 或稳定匿名昵称），**不展示公钥**。
- **不需要立场色条**（不做“支持/反对”的强提示条）。
- “首句截断”不能让标题/预览看起来很怪。
- Hover 卡片允许覆盖节点区域的一小部分（可接受遮挡）。

---

## 0. 用户任务（Jobs To Be Done）

用户在左侧扫图/扫列表时，hover 卡片承担三个职责：

1. **快速识别**：这是哪个观点（说了什么）？
2. **快速信任**：是谁说的（昵称即可）？大概被多少人支持（votes）？
3. **快速决策**：值不值得点击选中进入右侧阅读/讨论？

核心原则：hover 卡片的目标是「帮助决策」，不是「替代阅读区」。它必须**读得快、稳、少打扰**。

---

## 1. 卡片信息结构（不做立场色条）

### 1.1 必备字段（v1）

- **主标题**：`title`（若存在）否则 `首句（见 §3）`
- **作者昵称**：`authorDisplayName`（topic 内昵称）否则 `pseudonymFromAuthorId(authorId)`
- **热度/权重**：`totalVotes`
- **正文预览**：正文的前若干行（建议 2–4 行）

### 1.2 推荐字段（如果可得）

- **更新时间**：`updatedAt`（相对时间：3m/2h/1d）
- **子回复数**：`childCount`（如果当前视图/数据结构能提供）
- **聚类信息**（仅 GodView）：cluster label（如果存在）

### 1.3 展示层级（视觉上怎么排）

建议结构（从上到下）：

1. `作者昵称 · 主标题`（一行，主信息）
2. `●votes  ·  updatedAt  ·  replies`（一行，弱信息，monospace/小字）
3. `正文预览`（2–4 行，行高舒适，支持换行）

不展示立场条的情况下，卡片通过 **“昵称 + 票数 + 预览”** 就能完成判断。

---

## 2. Hover 交互（读感优先的状态机）

目标：消除“闪烁/抖动/追着鼠标跑”带来的阅读疲劳。

### 2.1 Hover 意图判定（anti-flicker）

- `enterDelay`：进入节点后延迟 `120–180ms` 才展示（过滤路过）
- `leaveDelay`：离开节点后延迟 `80–120ms` 再隐藏（抗手抖）
- 若在 `leaveDelay` 内重新进入同一节点：不重置动画/位置

### 2.2 位置策略（允许遮挡，但要“稳”）

- 卡片定位：以**指针位置**作为初始参考，做 `offset + clamp`：
  - `offset`：右下偏移（例如 +14px,+14px）
  - `clamp`：限制在左侧面板可视区域内
- **锁定策略**：卡片出现后，只要仍 hover 在同一节点上，卡片位置保持不变（避免读到一半抖动）
- 允许遮挡节点的一小部分，但建议：
  - hover 的节点本体要有明显高亮（描边/发光），保证“卡片 ↔ 节点”关系清晰

### 2.3 信息量渐进（“读一段再决定”但不需要 Pin）

为了兼顾“扫图速度”和“读一段”：

- 初始显示为 **短卡**：正文预览 `2–3 行`
- 若在同一节点上停留 `500–700ms`：自动扩展为 **长卡**：正文预览 `6–10 行`
- 鼠标离开立即回收（不需要 pin 交互）

> 解释：用户经常先扫全局，再对少数点停留。把“停留时间”当作阅读意图信号，比引入 pin 更轻、更不打断。

### 2.4 指针事件

- hover 卡片默认 `pointer-events: none`，避免卡片抢走鼠标导致 hover 状态抖动。
- 节点的点击仍是主动作：点击=选中（右侧进入阅读/讨论）。

---

## 3. “首句截断”规则（不怪的关键）

问题根源：直接 `slice(0, N)` 会造成：

- 截断在半个词/半句话中间（尤其英文）
- 截断在引号/括号开头后（视觉上像 bug）
- 首行是 Markdown 符号（`- `、`> `）导致标题很怪

### 3.1 主标题选择优先级

1. 若 `Argument.title` 非空：使用 `title.trim()`
2. 否则：从 `body` 抽取“首句标题”（`extractLeadSentence(body)`）

### 3.2 `extractLeadSentence`（建议算法）

输入：`body: string`

1) **预清洗**

- `trim()`
- 去掉首行常见前缀（仅首行）：`> `、`- `、`* `、`• `、`1. `、`1) `（避免把列表符号当标题）
- 把连续空白压缩（保留换行作为强分隔）

2) **先按“自然边界”截断（最不怪）**

按优先级寻找边界（找到就返回边界前内容）：

- **换行**：首个 `\n` 前的内容（如果长度足够）
- **句末标点**：在目标长度附近寻找 `。！？!?` `…` `.` `?` `!`

建议阈值：

- `minLen = 12`（太短的“首句”不当标题）
- `targetLen = 48`（希望在这个长度内找到自然句末）
- `hardMax = 80`（找不到句末就硬截断，但要做“体面”处理）

3) **找不到自然边界就“体面硬截断”**

- 英文/有空格：在 `targetLen..hardMax` 范围内优先取最后一个空格/逗号/分号作为切点
- 中文/无空格：按字符数截断到 `hardMax`

4) **尾部修饰（避免怪尾巴）**

- 移除截断后末尾的“开放符号”：`(` `（` `[` `【` `“` `「` `『`（避免 `作者·（……`）
- 移除末尾多余连接符：`:` `：` `-` `—` `，` `,`
- 若发生了截断：统一追加 `…`（单字符省略号）

### 3.3 示例（期望输出）

- 输入：`"- 我认为应该先做A，再做B，因为……"` → 标题：`"我认为应该先做A，再做B…"`
- 输入：`"（背景）这件事其实…"` → 标题：`"这件事其实…"`（去掉“开放括号”残留）
- 输入：`"This is a very long sentence that keeps going and going without a period"` → 标题：`"This is a very long sentence that keeps going…"`（在空格处体面截断）

---

## 4. 数据来源与性能（卡片必须“秒开”）

### 4.1 优先不请求网络

hover 卡片用于“扫”，必须尽量使用现有内存数据：

- `SunburstView / FocusView`：hover 只需要 `Argument` 的轻量字段（title/body/author/votes）
- `GodView`：cluster-map 点位本身不含正文时，可先显示“加载中”，但要有缓存并避免每次 hover 都请求

### 4.2 缓存策略（如果需要 fetch）

- 以 `argumentId` 为 key 的内存 cache（Map）
- 卡片短卡先渲染“已知字段”（标题/昵称/票数），正文晚到也可渐进填充
- 不在 hover 高频阶段做富文本渲染；正文预览可以用纯文本（避免昂贵渲染）

---

## 5. 验收标准（定义“好用”）

1. **不闪**：快速扫过多个节点不会频繁弹出/消失；停留才出现。
2. **不抖**：同一节点 hover 时卡片位置不跟随鼠标抖动。
3. **读得快**：短卡 2–3 行能让用户做出点击决策；停留后自动扩展让用户“读一段再决定”。
4. **标题不怪**：无 title 时，首句截断不出现 `- ` / `> ` / 半个括号 / 半个英文词。
5. **不泄露公钥**：只显示昵称（topic 内昵称或稳定匿名昵称）。


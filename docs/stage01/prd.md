# AI 思想市场 (The Thought Market)

## 产品需求文档 (v3.1)

---

## 1. 产品愿景

打造一个结合结构化辩论（Kialo）、机制设计（二次方投票 QV）、数据可视化和 AI 辅助治理（TalkToTheCity/Habermas Machine）的公共议题讨论平台。它是一个可视化的集体智慧决策系统，通过美学与算法，让共识与分歧在"数字生物组织"中自然生长。

视觉基调：设计系统向 Persona 5 对齐（“反叛 UI / 漫画印刷感”），并保留 Memphis 的拼贴语法作为辅助；配色与组件语法以 `docs/stage01/design.md` 为准。

---

## 2. 核心功能需求

### 2.1 结构化辩论与双重视图

采用 Kialo 式父子论点结构，根据数据规模自动切换视图。

#### 全局视图 (God View) – 语义地图（v1.0）/ S 型旭日图（后置）

| 属性 | 说明 |
|------|------|
| **触发条件** | 节点数 > 50 或首页总览 |
| **技术方案** | Canvas / WebGL (Pixi.js 或 Three.js) |
| **功能特性** | v1.0：语义地图（UMAP 2D 坐标 + Camp 分组）鸟瞰讨论热区；后置：旭日图用于宏观树结构总览 |

#### 局部视图 (Focus View)
属性	说明
触发条件 议题详情页的默认交互视图（替代原 Voronoi）
布局逻辑 自上而下 (Top-Down) 的层级结构，采用**“渐进式披露” (Progressive Disclosure)** 机制。初始仅显示根节点与第一层级，点击节点后动态展开其子分支。连接线严格采用直角折线 (Orthogonal Lines)，严禁使用曲线，以强化逻辑推演的严密感。
视觉风格	
• 视觉方向：Persona5 对齐的强风格化（厚描边、偏移投影、斜切构图、拼贴材质、半调网点）；详见 `docs/stage01/design.md`。
• 节点与容器：允许轻微旋转/倾斜与不规则裁切（`clip-path`），但信息层级必须通过描边与投影清晰区分。
• 权重可视化：QV 票数（Total Votes）越高，节点的几何尺寸越大，且边框与连接线越粗 (Visual Weight)。
• 权重传递（用于父子节点视觉大小/布局）：定义 `Stake_self(n)` 为节点自身的 **Total Votes（总票数）**；用于渲染的 `VisualWeight(n) = Stake_self(n) + α · Σ VisualWeight(c)`（c 为子节点，α ∈ [0,1]，Focus View 默认 0.5，God View 可取 1）。反对阵营的高分子节点不会“削弱”父节点几何尺寸：父节点尺寸表达“关注度/争议度”，立场仍由颜色编码。Cost（积分花费）仅用于扣费/资金明细与交易确认弹窗，不参与默认排序与尺寸计算。
• 立场编码：支持 `Electric`（`#2563eb`）/ 反对 `RebelRed`（`#ff0033`）/ 中立 `Acid`（`#facc15`）；描边与连线统一 `Ink`（`#1a1a1d`）。
---

### 2.2 交互细节：悬停、点击与输入

严格区分轻重交互，提供实时视觉反馈。

#### 悬停 (Hover) – 信息浮层

- 鼠标划过节点时，显示 Calling Card 式信息卡（厚描边 + 偏移投影 + 轻微不规则裁切/旋转），避免毛玻璃风（见 `docs/stage01/design.md`）。
- **内容**：原文片段（长文可用 LXGW WenKai，截取前 40 字）、用户昵称/Hash、当前总票数（Total Votes）等关键数值（等宽字体）
- **注意**：悬停不触发右侧面板变化

#### 点击 (Click) – 进入战场

- 点击某个节点，将其锁定为目标论题
- **响应**：右侧面板 (Dialogue Stream) 滑出或刷新，加载该节点下的所有子回复

---

### 2.3 经济系统：隔离的二次方投票 (QV)

| 规则 | 说明 |
|------|------|
| **资金池** | 每个用户在每个议题池 (Topic) 下独立拥有 100 积分，不可跨议题转移 |
| **计价公式** | `Cost = Votes²` (投 n 票消耗 n² 分) |
| **流动性** | 投票即质押。用户可随时撤回投票，积分全额退回当前议题账户；节点被 Host 枯萎/隐藏时**不自动退款**，但仍允许用户手动撤回（仅允许减票，禁止加票；见 2.6 / 2.5） |
| **排序** | 右侧面板中的观点流，默认按节点自身 `Stake_self`（Total Votes，总票数）降序排列（不使用子树聚合权重） |

---

### 2.4 AI 治理与报告 (后端核心)

> AI 是裁判与书记员，而非创作者。

#### 自动立场判定

- **流程**：用户提交文本 → AI 分析相对于父节点的立场 → 输出 Score (-1.0 ~ +1.0)
- **禁止**：严禁用于阵营聚类（防止"反对的反对"逻辑错误）

#### 阵营识别 (Camp Identification)

| 项目 | 说明 |
|------|------|
| **算法** | UMAP (降维) + HDBSCAN (密度聚类) |
| **特征** | 仅基于文本的语义向量 (Semantic Vectors) 进行聚类，完全忽略立场分 |
| **逻辑** | 只要语义接近（哪怕在互相攻击），就会被聚类在一起，形成自然的"讨论热区" |

#### 哈贝马斯共识报告 (The Consensus Report)

- **触发**：基于"动态重心收敛算法"自动触发，或 Host 手动触发
- **生成**：采用 Prompt Chaining 复刻 Habermas Machine 逻辑
  - 生成草案 → 模拟双边批评 → 递归修订
- **展示**：全屏模态框；外框/标题区遵循 Persona5 风格（厚描边、偏移投影、斜切与纹理），正文使用 LXGW WenKai 排版，展示主要阵营分歧及 AI 提炼的"共识桥梁"

---

### 2.5 身份与隐私 (客户端聚合)

> 采用极高匿名性的身份机制，后端零知晓。

#### 密钥体系

- 基于 **BIP39** 生成 Master Seed (存本地)
- **影子身份**：针对每个 Topic ID，通过 HMAC 派生独立的子密钥对 (Ed25519)
  - 后端无法关联 Topic A 的用户和 Topic B 的用户是同一人
- **鉴权**：除创建 Topic 的第一步（`POST /v1/topics`，用于获取 `topicId/rootArgumentId/claimToken` 等公共参数；此时尚未建立会话/身份，不强制签名是合理的）外，其余写请求与私密读均使用私钥签名，后端仅验证签名
- 派生与签名规范：见 `docs/stage01/crypto.md`

#### 账户备份 / 恢复 / 同步 (必需)

- **导出助记词**：在「我的」/设置提供“备份助记词”入口（默认不常驻展示，需二次确认后才可查看/复制）
- **导入助记词**：在首次进入（本地无 Seed）与「我的」/设置提供“恢复账户”入口，输入助记词后重建 Master Seed 并重新派生所有 Topic 影子身份
- **不可逆风险提示**：清理浏览器缓存/更换设备会丢失本地 Seed；未备份助记词将永久丢失积分资产与历史记录（后端无法找回）

#### "我的界面" (My Activity)

| 项目 | 说明 |
|------|------|
| **实现逻辑** | 纯客户端聚合 (Client-side Aggregation) |
| **存储方式** | 浏览器通过 IndexedDB 或 LocalStorage 记录用户访问过的 Topic 列表 |
| **渲染流程** | 浏览器遍历本地列表，实时派生公钥去后端查询状态 |
| **资产找回** | 必须能展示包括被 Prune 隐藏节点在内的质押记录，并提供“一键撤回 (Unstake)” |
| **严禁** | 后端建立"用户-议题"关联表 |

---

### 2.6 园丁权限 (Host)

> 去中心化的维护权，嵌入式管理。

**入口**：前端识别到当前用户公钥 = 议题创建者公钥时，显示 ⚙️ 管理图标

#### 权限列表

| 权限 | 说明 |
|------|------|
| **根议题修订** | 仅限修改文本 |
| **冻结归档** | 设为 Read-Only |
| **枯萎 (Pruning)** | 标记特定节点（如 Spam），强制赋予极大离心力或渲染权重归零（从视图隐藏，但数据库保留） |

#### 枯萎与资金清算

- **枯萎触发的清算**：当节点被标记为枯萎/隐藏时，系统对该节点上所有未撤回的质押**不自动退款**；但用户仍可手动撤回（资金可找回）。
- **写权限限制**：对 pruned 节点禁止增加票数，仅允许减少票数（`target_votes <= current_votes`），直到撤回为 0。
- **对权重计算的影响**：被枯萎节点在渲染中视为 `Stake_self = 0` 且从 `VisualWeight` 聚合中剔除，避免“幽灵权重”继续影响父节点大小与布局。
- **冻结归档不自动清算**：Read-Only 仅禁止新增节点/加票，但允许用户自行撤回既有质押。

#### 限制

- 无权修改 AI 参数
- 无权全员广播

---

## 3. 系统架构与技术栈
用 Turborepo 作为构建系统

### 前端

| 技术 | 说明 |
|------|------|
| **框架** | Next.js + React |
| **字体优化** | 使用 `next/font` 子集化加载：正文 LXGW WenKai；标题/标签使用窄体展示字（如 Bebas Neue/Oswald）；数据/公式使用等宽字体；视觉规范见 `docs/stage01/design.md` |
| **可视化** | D3.js (Focus View) + Three.js/Pixi.js (God View) |
| **编辑器** | TipTap |

### 后端

| 技术 | 说明 |
|------|------|
| **框架** | NestJS (Node.js) |
| **队列** | Redis + BullMQ (处理 AI 异步任务) |
| **微服务** | Python Service (可选，用于运行 scikit-learn 的 UMAP/HDBSCAN，若 Node.js 版本性能不足) |

### 实时通信与并发一致性

- **通信模式（v1.0）**：采用 SSE（Server-Sent Events）按 Topic 推送 Entity Invalidation（只推 `id+reason`），前端收到后做缓存失效再按需拉取；WebSocket（Socket.IO）作为后置选项。
- **推送事件**：投票/撤回、节点创建、节点枯萎/归档等状态变更均向在线用户推送失效通知，使气泡大小与排序无需手动刷新即可在秒级内同步。
- **一致性**：服务端账本为唯一真源；前端可做乐观渲染，收到服务端回执/广播后校正，避免并发下注导致的显示漂移。

### 数据库

| 技术 | 说明 |
|------|------|
| **数据库** | PostgreSQL + pgvector |
| **Schema** | `Topic` (含重心向量), `Argument` (含 Text + Vector + JSON), `UserLedger` (KV 存储) |

### AI 服务

| 服务 | 模型 | 用途 |
|------|------|------|
| **Embedding** | qwen/qwen3-embedding-8b | 语义向量生成 |
| **LLM (立场判定)** | google/gemini-3-flash-preview | 高频调用、快速响应 |
| **LLM (共识报告)** | deepseek/deepseek-v3.2 | Prompt Chaining、深度推理 |

---

## 4. 用户流程示例

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 浏览    用户进入议题，看到 Persona5 风格的强对比界面             │
│             左侧是色彩冲击的数据可视化                               │
├─────────────────────────────────────────────────────────────────┤
│  2. 探索    鼠标悬停在细胞上，浮层显示原文摘要                        │
│             点击感兴趣的细胞，右侧面板滑出"对话流"                    │
├─────────────────────────────────────────────────────────────────┤
│  3. 阅读    在右侧面板阅读目标观点                                  │
│     与加注   觉得很赞，拖动顶部滑块投 4 票（消耗 16 分）               │
├─────────────────────────────────────────────────────────────────┤
│  4. 辩论    在底部输入框撰写反驳                                    │
│     与预判   拖动滑块设定初始权重，左侧出现半透明虚影                   │
│             直观展示新观点将占据的地盘                              │
├─────────────────────────────────────────────────────────────────┤
│  5. 提交    点击发送，虚影转为实体细胞，并带有分裂动画                  │
├─────────────────────────────────────────────────────────────────┤
│  6. 回顾    点击右上角"我的"，浏览器读取本地 IndexedDB               │
│             列出我参与过的所有议题及投入情况                         │
└─────────────────────────────────────────────────────────────────┘
```

---

*文档版本: v3.1*

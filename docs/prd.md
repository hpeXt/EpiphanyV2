# AI 思想市场 (The Thought Market)

## 产品需求文档 (v3.0)

---

## 1. 产品愿景

打造一个结合结构化辩论（Kialo）、机制设计（二次方投票 QV）、数据可视化（Voronoi）和 AI 辅助治理（TalkToTheCity/Habermas Machine）的公共议题讨论平台。它是一个可视化的集体智慧决策系统，通过美学与算法，让共识与分歧在"数字生物组织"中自然生长。

---

## 2. 核心功能需求

### 2.1 结构化辩论与双重视图

采用 Kialo 式父子论点结构，根据数据规模自动切换视图。

#### 全局视图 (God View) – S 型旭日图

| 属性 | 说明 |
|------|------|
| **触发条件** | 节点数 > 50 或首页总览 |
| **技术方案** | Canvas / WebGL (Pixi.js 或 Three.js) |
| **功能特性** | 展示议题宏观全貌，支持平滑缩放、旋转、面包屑导航 |

#### 局部视图 (Focus View) – 加权泰森多边形 (Weighted Voronoi)
属性	说明
触发条件 议题详情页的默认交互视图（替代原 Voronoi）
布局逻辑 自上而下 (Top-Down) 的层级结构，采用**“渐进式披露” (Progressive Disclosure)** 机制。初始仅显示根节点与第一层级，点击节点后动态展开其子分支。连接线严格采用直角折线 (Orthogonal Lines)，严禁使用曲线，以强化逻辑推演的严密感。
视觉风格	
• “逻辑蓝图”风格。节点为圆角矩形卡片，背景素雅，内含论点摘要。
• 权重可视化：QV 积分越高，节点的几何尺寸越大，且边框与连接线越粗 (Visual Weight)。
• 立场编码：通过边框颜色区分阵营——强反对(深红边框) / 中立(灰色边框) / 强支持(深绿边框)。
---

### 2.2 交互细节：悬停、点击与输入

严格区分轻重交互，提供实时视觉反馈。

#### 悬停 (Hover) – 信息浮层

- 鼠标划过节点时，显示半透明毛玻璃卡片 (Tooltip)
- **内容**：原文片段（霞鹜文楷，截取前 40 字）、用户昵称/Hash、当前 QV 权重数值
- **注意**：悬停不触发右侧面板变化

#### 点击 (Click) – 进入战场

- 点击某个节点，将其锁定为目标论题
- **响应**：右侧面板 (Dialogue Stream) 滑出或刷新，加载该节点下的所有子回复

---

### 2.3 经济系统：隔离的二次方投票 (QV)

| 规则 | 说明 |
|------|------|
| **资金池** | 每个用户在每个议题池 (Topic) 下独立拥有 100 积分，不可跨议题转移 |
| **计价公式** | `Cost = Votes²` (投 n 票消耗 n² 分) |
| **流动性** | 投票即质押。用户可随时撤回投票，积分全额退回当前议题账户 |
| **排序** | 右侧面板中的观点流，默认按 QV 权重 (Total Staked) 降序排列 |

---

### 2.4 AI 治理与报告 (后端核心)

> AI 是裁判与书记员，而非创作者。

#### 自动立场判定

- **流程**：用户提交文本 → AI 分析相对于父节点的立场 → 输出 Score (-1.0 ~ +1.0)
- **用途**：仅用于决定 Voronoi 细胞的颜色和角度位置
- **禁止**：严禁用于阵营聚类（防止"反对的反对"逻辑错误）

#### 阵营识别 (Camp Identification)

| 项目 | 说明 |
|------|------|
| **算法** | UMAP (降维) + HDBSCAN (密度聚类) |
| **特征** | 仅基于文本的语义向量 (Semantic Vectors) 进行聚类，完全忽略立场分 |
| **逻辑** | 只要语义接近（哪怕在互相攻击），就会被聚类在一起，形成自然的"讨论热区" |

#### 哈贝马斯共识报告 (The Consensus Report)

- **触发**：基于"动态重心收敛算法"自动触发，或 Host 手动触发
- **生成**：采用 Prompt Chaining 复刻 Habermas Machine 逻辑
  - 生成草案 → 模拟双边批评 → 递归修订
- **展示**：全屏模态框，霞鹜文楷排版，展示主要阵营分歧及 AI 提炼的"共识桥梁"

---

### 2.5 身份与隐私 (客户端聚合)

> 采用极高匿名性的身份机制，后端零知晓。

#### 密钥体系

- 基于 **BIP39** 生成 Master Seed (存本地)
- **影子身份**：针对每个 Topic ID，通过 HMAC 派生独立的子密钥对 (Ed25519)
  - 后端无法关联 Topic A 的用户和 Topic B 的用户是同一人
- **鉴权**：全链路使用私钥签名，后端仅验证签名

#### "我的界面" (My Activity)

| 项目 | 说明 |
|------|------|
| **实现逻辑** | 纯客户端聚合 (Client-side Aggregation) |
| **存储方式** | 浏览器通过 IndexedDB 或 LocalStorage 记录用户访问过的 Topic 列表 |
| **渲染流程** | 浏览器遍历本地列表，实时派生公钥去后端查询状态 |
| **严禁** | 后端建立"用户-议题"关联表 |

---

### 2.6 园丁权限 (Host)

> 去中心化的维护权，嵌入式管理。

**入口**：前端识别到当前用户公钥 = 议题创建者公钥时，显示 ⚙️ 管理图标

#### 权限列表

| 权限 | 说明 |
|------|------|
| **根议题修订** | 仅限修改文本 |
| **冻结归档** | 设为 Read-Only |
| **枯萎 (Pruning)** | 标记特定节点（如 Spam），强制赋予极大离心力或权重归零（从视图隐藏，但数据库保留） |

#### 限制

- 无权修改 AI 参数
- 无权全员广播

---

## 3. 系统架构与技术栈
用 Turborepo 作为构建系统

### 前端

| 技术 | 说明 |
|------|------|
| **框架** | Next.js + React |
| **字体优化** | 使用 `next/font` 对霞鹜文楷 (LXGW WenKai) 进行子集化加载，确保首屏性能 |
| **可视化** | D3.js (Focus View) + Three.js/Pixi.js (God View) |
| **编辑器** | TipTap |

### 后端

| 技术 | 说明 |
|------|------|
| **框架** | NestJS (Node.js) |
| **队列** | Redis + BullMQ (处理 AI 异步任务) |
| **微服务** | Python Service (可选，用于运行 scikit-learn 的 UMAP/HDBSCAN，若 Node.js 版本性能不足) |

### 数据库

| 技术 | 说明 |
|------|------|
| **数据库** | PostgreSQL + pgvector |
| **Schema** | `Topic` (含重心向量), `Argument` (含 Text + Vector + JSON), `UserLedger` (KV 存储) |

### AI 服务

| 服务 | 模型 | 用途 |
|------|------|------|
| **Embedding** | qwen/qwen3-embedding-8b | 语义向量生成 |
| **LLM (立场判定)** | google/gemini-3-flash-preview | 高频调用、快速响应 |
| **LLM (共识报告)** | deepseek/deepseek-v3.2 | Prompt Chaining、深度推理 |

---

## 4. 用户流程示例

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 浏览    用户进入议题，看到霞鹜文楷风格的界面                      │
│             左侧是色彩斑斓的 Voronoi 光谱                          │
├─────────────────────────────────────────────────────────────────┤
│  2. 探索    鼠标悬停在细胞上，浮层显示原文摘要                        │
│             点击感兴趣的细胞，右侧面板滑出"对话流"                    │
├─────────────────────────────────────────────────────────────────┤
│  3. 阅读    在右侧面板阅读目标观点                                  │
│     与加注   觉得很赞，拖动顶部滑块投 4 票（消耗 16 分）               │
├─────────────────────────────────────────────────────────────────┤
│  4. 辩论    在底部输入框撰写反驳                                    │
│     与预判   拖动滑块设定初始权重，左侧出现半透明虚影                   │
│             直观展示新观点将占据的地盘                              │
├─────────────────────────────────────────────────────────────────┤
│  5. 提交    点击发送，虚影转为实体细胞，并带有分裂动画                  │
├─────────────────────────────────────────────────────────────────┤
│  6. 回顾    点击右上角"我的"，浏览器读取本地 IndexedDB               │
│             列出我参与过的所有议题及投入情况                         │
└─────────────────────────────────────────────────────────────────┘
```

---

*文档版本: v3.0*
